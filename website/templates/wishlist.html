{% extends "base.html" %} {% block title %}Wish List{% endblock %} {% block content
  %}
   <style>
    input:placeholder-shown {
      font-style: italic;
    }

    .unhook-button {
      color: red;
    }

    /* Price field editing styles */
    td[data-field="price"] {
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    td[data-field="price"]:hover {
      background-color: #f8f9fa;
    }

    td[data-field="price"]:focus {
      background-color: #e9ecef;
      outline: 2px solid #007bff;
      outline-offset: -2px;
    }

    /* Price validation styles */
    .price-error {
      background-color: #f8d7da !important;
      border: 1px solid #f5c6cb !important;
    }

    /* Price editing state */
    .price-editing {
      background-color: #fff3cd !important;
      border: 1px solid #ffeaa7 !important;
    }

    /* Wishlist page background pattern */
    body.wishlist-bg {
      /* image from https://wallpapercave.com/beatrix-potter-wallpapers */
      background-image: url('/static/wishlist-pattern.png');
      background-repeat: repeat;
      background-size: 380px auto;
      background-position: top left;
      background-attachment: scroll;
    }

    /* Translucent content overlay */
    .wishlist-content-card {
      background-color: rgba(255, 255, 255, 0.86);
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      padding: 24px;
      margin: 24px auto;
      max-width: 1100px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }

    /* Image thumbnail wrapper and remove control */
    .image-thumb-wrapper {
      position: relative;
      display: inline-block;
    }

    .image-thumb {
      max-width: 80px;
      max-height: 80px;
      object-fit: cover;
      margin: 5px 0;
      cursor: pointer;
      display: block;
    }

    .image-remove-ctrl {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255, 255, 255, 0.7);
      color: #333;
      width: 18px;
      height: 18px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .image-remove-ctrl:hover {
      background: rgba(255, 255, 255, 0.9);
    }

   </style>
  <!-- this is the same as base.html and overwrite any blocks -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('wishlist-bg');
    });
  </script>
  <div class="wishlist-content-card">
  <br>
  <h2 align="center">&#128722; Wish List &#128722;</h2>
  <a class="btn btn-primary" style="float: right;" href="{{ url_for('views.unhooked_list') }}">Go to my Unhooked List</a>
  <br>
  <br>
  <a class="btn btn-info" style="float: right;" href="{{ url_for('views.purchased_list') }}">Go to my Purchase List</a>
  <br>
  {% set totalprice = namespace(value=0.00) %}
  {% set totalpurchasedprice = namespace(value=0.00) %}
  {% set totalfavoriteprice = namespace(value=0.00) %}
  {% for wishitem in user.wishitems %}
  {% if not wishitem.unhooked and not wishitem.purchased %}
  {% set totalprice.value = totalprice.value + wishitem.taxed_price %}
  {% endif %}
  {% if not wishitem.unhooked and wishitem.purchased %}
  {% set totalpurchasedprice.value = totalpurchasedprice.value + wishitem.taxed_price %}
  {% endif %}
  {% if wishitem.favorited and not wishitem.unhooked and not wishitem.purchased%}
  {% set totalfavoriteprice.value = totalfavoriteprice.value + wishitem.taxed_price %}
  {% endif %}
  {% endfor %}
  {% set totalprice.value =  totalprice.value|round(2) %}
  {% set totalpurchasedprice.value =  totalpurchasedprice.value|round(2) %}
  {% set totalfavoriteprice.value =  totalfavoriteprice.value|round(2) %}
  <div style="display: flex; justify-content: space-between;">
    <p> <b> &#128722; Total value of items: <font color="blue">${{ totalprice.value | format_money }}
    </b></font>&nbsp; &#128150;<b> Total favorited: <font color="gold"> ${{ totalfavoriteprice.value | format_money }}
    <br>
    </b></font>&#128717; <b>Total purchased: <font color="#ff0000"> ${{ totalpurchasedprice.value | format_money }}
    </b></font></p>
  </div>

  <ul class="list-group list-group-flush" id="wishItems">
    <table id="wishlist-table" class="table table-sm">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col" style="position: relative;">
            <span id="timeHeader" style="cursor: pointer;" onclick="toggleDateFilterPopup()">Time</span>
            <div id="dateFilterPopup" class="date-filter-popup" style="display: none; position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ccc; padding: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 100;">
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <label for="startDate" style="margin: 0;">Start</label>
                <input type="date" id="startDate" onchange="handleDateChange()">
                <label for="endDate" style="margin: 0;">End</label>
                <input type="date" id="endDate" onchange="handleDateChange()">
              </div>
              <button type="button" class="btn btn-secondary btn-sm" onclick="resetDateFilter()">Show All</button>
            </div>
          </th>
          <th scope="col">Brand
          <select id="brandFilter" onchange="filterTable()">
            <option value="">All brands</option>
            {% for brand in brands %}
            <option value="{{ brand }}">{{ brand }}</option>
            {% endfor %}
          </select>
          </th>
          <th scope="col">Category
            <select id="tagFilter" onchange="filterTable()">
              <option value="">All categories</option>
              {% for category in categories %}
              <option value="{{ category }}">{{ category }}</option>
              {% endfor %}
            </select>
          </th>
          <th scope="col">Name</th>
          <th scope="col">üíñ</th>
          <th scope="col">Price (inc.tax)</th>
          <th scope="col">Added</th>

        </tr>
      </thead>
      <li class="list-group-item">
      {% set count = namespace(value=0) %}
      {% for wishitem in user.wishitems %}
      {% if not wishitem.unhooked and not wishitem.purchased %}
      {% set count.value = count.value + 1 %}
        <tr data-wishitem-id="{{ wishitem.id }}" data-wishitem-category="{{ wishitem.category }}" data-wishitem-brand="{{ wishitem.brand }}" data-wishitem-time="{{ wishitem.date.isoformat() if wishitem.date else '' }}">
          <th scope="row">{{count.value}}</th>
          <td> {{wishitem.date | format_datetime}} </td>
          <td contenteditable="true" oninput="autoSave(this)"> {{wishitem.brand}} </td>
          <td contenteditable="true" oninput="autoSave(this)">
            {{ wishitem.category }}<br>
            <span style="font-size: smaller; color: grey; font-style: italic;">
              {{ wishitem.tag | format_tag }}
            </span>
          </td>
          <td contenteditable="true" oninput="autoSave(this)">
            <span style="color: blue; text-decoration: underline; font-size:11pt" onclick="window.open('{{ wishitem.link }}', '_blank')"> {{wishitem.name}} </span> <br>
            {% if wishitem.image_url %}
              <div class="image-thumb-wrapper" data-wishitem-id="{{ wishitem.id }}">
                <img class="image-thumb" src="{{ wishitem.image_url }}" alt="{{ wishitem.name }}" onclick="openImageModal('{{ wishitem.image_url }}', '{{ wishitem.name }}')">
                <div class="image-remove-ctrl" title="Remove image" onclick="removeWishItemImage({{ wishitem.id }}, this, event)">√ó</div>
              </div>
              <br>
            {% endif %}
            <span class="desc-container" style="font-size: smaller; color: grey; font-style: italic;">
              {{ wishitem.description | format_description }}
            </span>
          </td>
          <td>
            <button type="button" class="close" onclick="toggleFavoriteWishItem({{ wishitem.id }})">
              <!-- <span class="favorite-icon" style="font-size: 11pt;" aria-hidden="true">‚†Ä</span> Heart emoji &#10084;-->
              <span id="favorite-button" style="font-size: 11pt;" aria-hidden="true">
                {% if wishitem.favorited %}
                  üíñ
                {% else %}
                  ‚óΩÔ∏è
                {% endif %}
              </span>
            </button>
          </td>
          <td contenteditable="true" oninput="autoSave(this)" onblur="finishPriceEdit(this)" onkeydown="handlePriceKeyDown(event, this)" data-field="price" data-wishitem-id="{{ wishitem.id }}" data-tax-rate="0.0875" data-pretax-price="{{ wishitem.price if wishitem.price else 0 }}" data-displayed-price="{{ (wishitem.taxed_price|round(2) if wishitem.taxed_price != None else 0 ) | format_money }}">
            {{ (wishitem.taxed_price|round(2) if wishitem.taxed_price != None else 0 ) | format_money }}
          </td>
          <td>
            {% if wishitem.wish_period %}
              {{ wishitem.wish_period | format_time }}
              {% else %}
                {% if wishitem.date %}
                  <!-- {{ (current_time - wishitem.date) | debug }} -->
                  {{ (current_time - wishitem.date) | format_time }}
                {% else %}
                  {{ None }}
                {% endif %}
              {% endif %}
          </td>
          <td>
            <button type="button" class="close" onclick="toggleWishItem({{ wishitem.id }}, true, false, '/my-wishlist'); addWishItemPeriod({{wishitem.id}}, '/my-wishlist')">
              <span id='unhook-button' style="color: blue; font-size: 11pt;" aria-hidden="true"> unhook&#129693;</span>
            </button>
          </td>
          <td>
          <button type="button" class="close" onclick="toggleWishItem({{ wishitem.id }}, false, true, '/my-wishlist'); addWishItemPeriod({{wishitem.id}}, '/my-wishlist')">
          <span id='purchase-button' style="color: red; font-size: 11pt;" aria-hidden="true"> purchase&#129297;</span>
          </button>
          </td>
          <td>
          <button type="button" class="close" onClick="deleteItem({{ wishitem.id }}, '/my-wishlist')">
            <span aria-hidden="true">&times;</span>
          </button>
          </td>
        </tr>
      {% endif %}
      </li>
      {% endfor %}
      </table>
    </ul>
  <!--br>
  <hr width="50%" color="green" size="50px" />
  <img src="./website/static/" alt="Italian Trulli"-->
  <br>
  <hr width="50%" color="green" size="50px" />
  <h2 align="center">&#128156; Add New Item &#128156;</h2>
 <form method="POST">
   <!-- sample: Madewell, Dress, Linen Blue, madewell.com, 129.12-->
   <body>
   <table align="center">
     <tbody>
       <tr>
         <td>
           Enter Brand*:
         </td>
         <td>
           <input type="text" id="brand" name="brand" size=60 placeholder="Rouje">
         </td>
       </tr>
      <tr>
       <td>
         Enter Category*:
       </td>
       <td>
        <select id="category" name="category">
          <option value="">Select Category</option>
          <option value="Top">Top</option>
          <option value="Pants">Pants</option>
          <option value="Skirt">Skirt</option>
          <option value="Bag">Bag</option>
          <option value="Dress">Dress</option>
          <option value="Shoes">Shoes</option>
          <option disabled>------</option>
          <option value="Beauty">Beauty/Makeup</option>
          <option value="Jacket">Jacket</option>
          <option value="Ring">Ring</option>
          <option value="Earrings">Earrings</option>
          <option value="Wallet">Wallet</option>
          <option value="Pajamas">Pajamas</option>
          <option value="Underwear">Underwear</option>
          <option value="Scarf">Scarf</option>
          <option value="Living">Living</option>
          <option value="Other accessories">Other accessories</option>
          <option value="Other">Other (e.g. Luggage)</option>
        </select>
        </td>
      </tr>
      <tr>
        <td>
          Enter Tag:
        </td>
        <td>
          <input type="text" id="tag" name="tag" size=60 placeholder="Tag">
        </td>
       </tr>
      <tr>
       <td>
         Enter Name*:
       </td>
       <td>
         <input type="text" id="name" name="name" size=60 placeholder="CYRIELLE DRESS">
       </td>
      </tr>
      <tr>
        <td>
          Enter Description:
        </td>
        <td>
          <input type="text" id="description" name="description" size=60 placeholder="Pink Dress">
        </td>
       </tr>
      <tr>
       <td>
         Enter Price*:
       </td>
       <td>
         <input type="text" id="price" name="price" size=60 placeholder="212.00">
       </td>
      </tr>
      <tr>
        <td>
          Enter Deliver Fee (if exists):
        </td>
        <td>
          <input type="text" id="delivery-fee" name="delivery-fee" size=60 placeholder="30.00">
        </td>
      </tr>
      <tr>
        <td>
          Enter Link*:
        </td>
        <td>
          <input type="text" id="link" name="link" size=60 placeholder="https://us.rouje.com/products/cyrielle-fleurdepechepeche">
        </td>
       </tr>
     </tbody>
   </table>

    <!-- Add the JavaScript code here -->
    <script>
      document.getElementById('link').addEventListener('blur', function() {
          const url = this.value;
          if (url) {
              fetch('/fetch-url-info', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ url: url })
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      document.getElementById('name').value = data.name;
                      document.getElementById('price').value = data.price;
                      document.getElementById('brand').value = data.brand;
                      document.getElementById('description').value = data.description;
                      // Store image_url in a hidden field
                      if (data.image_url) {
                          if (!document.getElementById('image_url')) {
                              const hiddenField = document.createElement('input');
                              hiddenField.type = 'hidden';
                              hiddenField.id = 'image_url';
                              hiddenField.name = 'image_url';
                              document.querySelector('form').appendChild(hiddenField);
                          }
                          document.getElementById('image_url').value = data.image_url;
                      }
                  } else {
                      alert('Failed to fetch URL information');
                  }
              })
              .catch(error => console.error('Error:', error));
          }
      });

      function autoSave(cell) {
            const row = cell.parentNode;
            const wishitemId = cell.getAttribute('data-wishitem-id') || row.getAttribute('data-wishitem-id');
            const field = cell.getAttribute('data-field');

                                    if (field === 'price') {
              // Don't process price updates while user is still typing
              // This will be handled when the user finishes editing (onblur)
              return;
            } else {
              // Handle other editable fields (existing logic)
              const cells = row.querySelectorAll('td[contenteditable="true"]:not([data-field="price"])');

              // Extract brand and category/tag as-is
              const brandVal = cells[0] ? cells[0].innerText : '';
              const categoryTagVal = cells[1] ? cells[1].innerText : '';

              // For Name/Description, exclude Show more/less and use only description text
              const nameDescCell = cells[2];
              let nameVal = '';
              let descVal = '';
              if (nameDescCell) {
                const nameEl = nameDescCell.querySelector('span[style*="text-decoration: underline"]');
                nameVal = nameEl ? nameEl.textContent.trim() : (nameDescCell.innerText.split('\n')[0] || '').trim();
                const descContainer = nameDescCell.querySelector('.desc-container');
                const descTextEl = descContainer ? descContainer.querySelector('.desc-text') : null;
                if (descContainer && descTextEl) {
                  // Keep data-full in sync with what's visible/edited
                  descContainer.setAttribute('data-full', descTextEl.textContent.trim());
                  descVal = descContainer.getAttribute('data-full') || '';
                } else {
                  descVal = (nameDescCell.innerText.split('\n')[1] || '').trim();
                }
              }
              const nameDescVal = nameVal + (descVal ? ('\n' + descVal) : '');

              const data = [brandVal, categoryTagVal, nameDescVal];

              // print/log the data to the console
              console.log(data); // print data array to browser console (F12 -> Console tab)

              // Send the data to the server using fetch or XMLHttpRequest
              fetch('/save-table', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ wishItemId: wishitemId, Brand: data[0], Category_Tag: data[1], Name_Description: data[2] })
              }).then(response => response.json())
              .then(data => console.log(data))
              .catch(error => console.error('Error:', error));
            }
        }
      // Function to filter table based on category, brand, and date range
      function filterTable() {
        var categoryFilter = document.getElementById("tagFilter").value.toLowerCase();
        console.log('categoryFilter:', categoryFilter);
        var brandFilter = document.getElementById("brandFilter").value.toLowerCase();
        console.log('brandFilter:', brandFilter);

        var startInput = document.getElementById("startDate");
        var endInput = document.getElementById("endDate");
        var startDateValue = startInput && startInput.value ? startInput.value : "";
        var endDateValue = endInput && endInput.value ? endInput.value : "";
        var startDate = startDateValue ? new Date(startDateValue) : null;
        var endDate = endDateValue ? new Date(endDateValue) : null;
        if (endDate) { endDate.setHours(23, 59, 59, 999); }

        var rows = document.querySelectorAll("#wishlist-table tbody tr");

        rows.forEach(row => {
          var tdCategory = (row.getAttribute("data-wishitem-category") || "").toLowerCase();
          console.log('tdCategory:', tdCategory);
          var tdBrand = (row.getAttribute("data-wishitem-brand") || "").toLowerCase();
          var rowTimeAttr = row.getAttribute("data-wishitem-time") || "";
          var rowDate = rowTimeAttr ? new Date(rowTimeAttr) : null;

          var categoryMatch = (categoryFilter === "" || tdCategory.includes(categoryFilter));
          var brandMatch = (brandFilter === "" || tdBrand.includes(brandFilter));
          var dateMatch = true;

          if (startDate || endDate) {
            if (rowDate) {
              if (startDate && endDate) {
                dateMatch = rowDate >= startDate && rowDate <= endDate;
              } else if (startDate) {
                dateMatch = rowDate >= startDate;
              } else if (endDate) {
                dateMatch = rowDate <= endDate;
              }
            } else {
              dateMatch = false;
            }
          }

          if (categoryMatch && brandMatch && dateMatch) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      function toggleDateFilterPopup(forceState) {
        var popup = document.getElementById("dateFilterPopup");
        if (!popup) return;
        if (typeof forceState === "boolean") {
          popup.style.display = forceState ? "block" : "none";
          return;
        }
        popup.style.display = (popup.style.display === "none" || popup.style.display === "") ? "block" : "none";
      }

      function handleDateChange() {
        var startInput = document.getElementById("startDate");
        var endInput = document.getElementById("endDate");
        if (!startInput || !endInput) return;

        if (startInput.value && endInput.value) {
          filterTable();
          toggleDateFilterPopup(false);
        }
      }

      function resetDateFilter() {
        var startInput = document.getElementById("startDate");
        var endInput = document.getElementById("endDate");
        if (startInput) startInput.value = "";
        if (endInput) endInput.value = "";

        var brandFilterEl = document.getElementById("brandFilter");
        var tagFilterEl = document.getElementById("tagFilter");
        if (brandFilterEl) brandFilterEl.value = "";
        if (tagFilterEl) tagFilterEl.value = "";

        filterTable();
        toggleDateFilterPopup(false);
      }
      </script>
   <br />
   <div align="center">
    <button type="submit" class="btn btn-primary">Add Item</button>
   </div>
  </body>
  <script>
    // Save scroll position before form submission
    document.querySelector('form').addEventListener('submit', function() {
      localStorage.setItem('scrollPosition', window.scrollY);
    });

    // Restore scroll position after page reload
    window.addEventListener('load', function() {
      const scrollPosition = localStorage.getItem('scrollPosition');
      if (scrollPosition) {
        window.scrollTo(0, scrollPosition);
        localStorage.removeItem('scrollPosition'); // Clean up
      }

      // Truncate descriptions and add Show more/Show less controls
      const MAX_DESC = 90;
      const descNodes = document.querySelectorAll('.desc-container');

      function renderDesc(node) {
        const full = node.getAttribute('data-full') || '';
        const expanded = node.getAttribute('data-expanded') === 'true';
        const truncated = node.getAttribute('data-truncated') || full;
        node.innerHTML = '';

        const textSpan = document.createElement('span');
        textSpan.className = 'desc-text';
        textSpan.textContent = expanded ? full : truncated;
        node.appendChild(textSpan);

        if (full.length > MAX_DESC) {
          const toggle = document.createElement('span');
          toggle.className = 'desc-toggle';
          toggle.setAttribute('contenteditable', 'false');
          toggle.innerHTML = expanded ? ' <em><u>Show less</u></em>' : ' <em><u>Show more</u></em>';
          node.appendChild(toggle);
        }
      }

      descNodes.forEach(node => {
        const full = node.textContent.trim();
        node.setAttribute('data-full', full);
        if (full.length > MAX_DESC) {
          let truncated = full.slice(0, MAX_DESC).trimEnd();
          const lastSpace = truncated.lastIndexOf(' ');
          if (lastSpace > 40) truncated = truncated.slice(0, lastSpace);
          node.setAttribute('data-truncated', truncated);
          node.setAttribute('data-expanded', 'false');
        } else {
          node.setAttribute('data-expanded', 'true');
        }
        renderDesc(node);
      });

      // Prevent focus/caret on toggles inside contenteditable cells
      document.addEventListener('mousedown', function(e) {
        if (e.target.closest && e.target.closest('.desc-toggle')) {
          e.preventDefault();
        }
      });

      // Handle Show more/Show less clicks only
      document.addEventListener('click', function(e) {
        const toggleEl = e.target.closest && e.target.closest('.desc-toggle');
        if (!toggleEl) return;
        e.preventDefault();
        e.stopPropagation();
        const container = toggleEl.closest('.desc-container');
        if (!container) return;
        const expanded = container.getAttribute('data-expanded') === 'true';
        container.setAttribute('data-expanded', expanded ? 'false' : 'true');
        renderDesc(container);
      });

            // Initialize price fields with original values for validation
      const priceFields = document.querySelectorAll('td[data-field="price"]');
      priceFields.forEach(field => {
        const currentValue = field.innerText.trim();

        // Ensure the displayed value always has $ symbol
        if (!currentValue.startsWith('$')) {
          field.innerText = '$' + currentValue;
        }

        field.setAttribute('data-original-value', field.innerText);

                                // Initialize the pre-tax price properly
        // The data-pretax-price attribute should contain the actual pre-tax price from the database
        let storedPreTaxPrice = field.getAttribute('data-pretax-price');

        // Debug logging to see what's happening
        console.log('Price field initialized:', {
          displayed: currentValue,
          storedPreTax: storedPreTaxPrice,
          taxRate: field.getAttribute('data-tax-rate'),
          rawAttribute: field.outerHTML
        });

        // If no pre-tax price is stored or it's 0, we need to calculate it from the displayed taxed price
        if (!storedPreTaxPrice || storedPreTaxPrice === '0') {
          const displayedPrice = currentValue.replace(/[$,]/g, '');
          const taxRate = parseFloat(field.getAttribute('data-tax-rate') || '0.0875');
          const calculatedPreTaxPrice = parseFloat(displayedPrice) / (1 + taxRate);
          field.setAttribute('data-pretax-price', calculatedPreTaxPrice.toString());
          storedPreTaxPrice = calculatedPreTaxPrice.toString();
          console.log('Calculated pre-tax price from displayed:', calculatedPreTaxPrice);
        }

                // Add focus and blur event listeners for smooth editing
        field.addEventListener('focus', function() {
          this.classList.add('price-editing');

          // Always show the stored pre-tax price when editing starts
          const preTaxPrice = this.getAttribute('data-pretax-price');
          console.log('Focus event - stored pre-tax price:', preTaxPrice);
          console.log('Current displayed value:', this.innerText);

          if (preTaxPrice && preTaxPrice !== '0') {
            // Show pre-tax price WITHOUT $ symbol for clean editing
            const displayPrice = parseFloat(preTaxPrice).toFixed(2);
            this.innerText = displayPrice;
            console.log('Showing pre-tax price for editing:', displayPrice);
            console.log('User will now edit the pre-tax price (no $ symbol):', displayPrice);
          } else {
            // This should never happen if initialization worked properly
            console.error('No pre-tax price found! This indicates an initialization problem.');
            // Fallback: calculate from displayed value but this is not ideal
            const currentDisplayedPrice = this.innerText.replace(/[$,]/g, '');
            const taxRate = parseFloat(this.getAttribute('data-tax-rate') || '0.0875');
            const reversePreTaxPrice = parseFloat(currentDisplayedPrice) / (1 + taxRate);
            this.innerText = reversePreTaxPrice.toFixed(2);
            this.setAttribute('data-pretax-price', reversePreTaxPrice.toString());
            console.log('Fallback: calculated pre-tax price from displayed:', reversePreTaxPrice);
          }

          // Set cursor to end of text
          this.focus();
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(this);
          range.collapse(false);
          selection.removeAllRanges();
          selection.addRange(range);
        });

        field.addEventListener('blur', function() {
          this.classList.remove('price-editing');
        });
      });
    });

    // Image modal functionality
    function openImageModal(imageUrl, imageName) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      const modalCaption = document.getElementById('modalCaption');

      modalImg.src = imageUrl;
      modalCaption.textContent = imageName;
      modal.style.display = 'block';
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
    }

    // Close modal when clicking outside the image
    window.onclick = function(event) {
      const modal = document.getElementById('imageModal');
      if (event.target === modal) {
        closeImageModal();
      }
    }

    // Function to handle key presses in price field
    function handlePriceKeyDown(event, cell) {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent default Enter behavior
        finishPriceEdit(cell);
        // Remove focus from the cell to complete editing
        cell.blur();
      }
    }

    // Test function to verify tax calculations
    function testTaxCalculation() {
      const testPrice = 124.00;
      const taxRate = 0.0875;
      const expectedTaxed = testPrice * (1 + taxRate);
      const reverseCalculated = expectedTaxed / (1 + taxRate);

      console.log('Tax calculation test:', {
        original: testPrice,
        taxRate: taxRate,
        expectedTaxed: expectedTaxed,
        reverseCalculated: reverseCalculated,
        difference: testPrice - reverseCalculated
      });
    }

    // Run the test when page loads
    testTaxCalculation();

    // Test the HTML attributes
    console.log('=== HTML ATTRIBUTE TEST ===');
    const testPriceField = document.querySelector('td[data-field="price"]');
    if (testPriceField) {
      console.log('Test price field HTML:', testPriceField.outerHTML);
      console.log('data-pretax-price attribute:', testPriceField.getAttribute('data-pretax-price'));
      console.log('data-tax-rate attribute:', testPriceField.getAttribute('data-tax-rate'));
    }

        // Function to handle price editing completion
    // IMPORTANT: This function assumes the user is entering the PRE-TAX price
    // When editing starts, the user sees the pre-tax price from the database
    // When they finish editing, their input is treated as the new pre-tax price
    // Tax is then calculated and the taxed price is displayed
    function finishPriceEdit(cell) {
      const wishitemId = cell.getAttribute('data-wishitem-id');
      const taxRate = parseFloat(cell.getAttribute('data-tax-rate') || '0.0875');
      let priceValue = cell.innerText.trim();

      console.log('=== PRICE EDITING COMPLETION ===');
      console.log('User finished editing price field');
      console.log('Raw input from user:', priceValue);

      // Remove currency symbols and commas, convert to number
      priceValue = priceValue.replace(/[$,]/g, '');
      console.log('Cleaned input value:', priceValue);

      // Validate price
      if (isNaN(priceValue) || parseFloat(priceValue) < 0) {
        alert('Please enter a valid price (positive number)');
        // Reset to original value (ensure it has $ symbol)
        const originalValue = cell.getAttribute('data-original-value') || '$0.00';
        cell.innerText = originalValue;
        cell.classList.add('price-error');
        setTimeout(() => cell.classList.remove('price-error'), 2000);
        return;
      }

      const preTaxPrice = parseFloat(priceValue);
      const taxAmount = preTaxPrice * taxRate;
      const totalPrice = preTaxPrice + taxAmount;

      // Format the total price (including tax) for display
      const formattedTotalPrice = totalPrice.toFixed(2);

      // Debug logging
      console.log('Price calculation:', {
        userInput: priceValue,
        preTaxPrice: preTaxPrice,
        taxRate: taxRate,
        taxAmount: taxAmount,
        totalPrice: totalPrice,
        formattedTotal: formattedTotalPrice
      });

      console.log('IMPORTANT: User entered', priceValue, 'which is being treated as PRE-TAX price');
      console.log('Tax calculation:', preTaxPrice, '√ó', (1 + taxRate), '=', totalPrice);

      // Show the total price (including tax) to the user WITH $ symbol
      cell.innerText = '$' + formattedTotalPrice;

            // Store the TRUE pre-tax price that the user entered for future editing
      // This prevents tax compounding on subsequent edits
      cell.setAttribute('data-pretax-price', preTaxPrice.toString());

      console.log('Stored pre-tax price:', preTaxPrice);
      console.log('Updated data-pretax-price attribute to:', preTaxPrice.toString());

      // Send price update to server (store pre-tax price)
      fetch('/save-table', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          wishItemId: wishitemId,
          field: 'price',
          value: preTaxPrice
        })
      }).then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Price updated:', data.message);
          // Store the new formatted value as original for future reference
          cell.setAttribute('data-original-value', '$' + formattedTotalPrice);
          // Show success feedback
          cell.style.backgroundColor = '#d4edda';
          setTimeout(() => cell.style.backgroundColor = '', 1000);
        } else {
          console.error('Price update failed:', data.error);
          // Reset to original value on error (ensure it has $ symbol)
          const originalValue = cell.getAttribute('data-original-value') || '$0.00';
          cell.innerText = originalValue;
          cell.classList.add('price-error');
          setTimeout(() => cell.classList.remove('price-error'), 2000);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Reset to original value on error (ensure it has $ symbol)
        const originalValue = cell.getAttribute('data-original-value') || '$0.00';
        cell.innerText = originalValue;
        cell.classList.add('price-error');
        setTimeout(() => cell.classList.remove('price-error'), 2000);
      });
    }
  </script>
 </form>

 <!-- Image Modal -->
 <div id="imageModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9);">
   <div style="position: relative; margin: auto; padding: 20px; width: 80%; max-width: 800px; text-align: center;">
     <span class="close" onclick="closeImageModal()" style="position: absolute; top: 10px; right: 25px; color: #f1f1f1; font-size: 35px; font-weight: bold; cursor: pointer;">&times;</span>
     <img id="modalImage" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
     <div id="modalCaption" style="margin: auto; display: block; width: 80%; max-width: 700px; text-align: center; color: #ccc; padding: 10px 0; height: 150px;"></div>
   </div>
 </div>
  </div>
 {% endblock %}
