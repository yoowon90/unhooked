{% extends "base.html" %} {% block title %}Purchase List{% endblock %} {% block content
  %}
  <!-- below is sample style -->
   <style>
    input:placeholder-shown {
      font-style: italic;
    }

    /* Pastel row background across all cells */
    #purchasedlist-table tr.table-danger > * { background-color: #fee4eb !important; }
    #purchasedlist-table tr.table-warning > * { background-color: #fbf5e6 !important; }
    #purchasedlist-table tr.table-success > * { background-color: #d5f0f7 !important; }

    /* Always keep borders grey regardless of row background */
    #purchasedlist-table { --bs-table-border-color: #dee2e6 !important; }
    #purchasedlist-table th,
    #purchasedlist-table td { border-color: #dee2e6 !important; }

    /* Purchased page background pattern */
    body.purchased-bg {
      /* image from https://www.redbubble.com/i/art-board-print/Nursery-Characters-Peter-Rabbit-Beatrix-Potter-by-SvetlanaArt/146953707.7Q6GI */
      background-image: url('/static/purchased-pattern.png');
      background-repeat: repeat;
      background-size: 260px auto;
      background-position: top left;
      background-attachment: scroll;
    }

    /* Translucent content overlay */
    .purchased-content-card {
      background-color: rgba(255, 255, 255, 0.86);
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      padding: 24px;
      margin: 24px auto;
      max-width: 1100px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }
   </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('purchased-bg');
    });
  </script>

  <div class="purchased-content-card">
  <!-- this is the same as base.html and overwrite any blocks -->
  <br>
  <h2 align="center">&#129534; Purchase List &#129534;</h2>
    <a class="btn btn-warning" style="float: right;" href="{{ url_for('views.wishlist') }}">Go to my Wish List</a>
    <br>
    <br>
    <a class="btn btn-primary" style="float: right;" href="{{ url_for('views.unhooked_list') }}">Go to my Unhooked List</a>
  <br>
  {% set totalpurchasedprice = namespace(value=0.00) %}
  {% for wishitem in user.wishitems %}
  {% if not wishitem.unhooked and wishitem.purchased %}
  {% set totalpurchasedprice.value = totalpurchasedprice.value + wishitem.taxed_price %}
  {% endif %}
  {% endfor %}
  {% set totalpurchasedprice.value =  totalpurchasedprice.value|round(2) %}
  <div style="display: flex; justify-content: space-between;">
    <p> <b> &#128717; Total purchased: <font color="#ff0000"> ${{ totalpurchasedprice.value | format_money }} </b></font></p>
  </div>
  <ul class="list-group list-group-flush" id="wishItems">
    <table class="table table-sm" id="purchasedlist-table">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col" style="position: relative;">
            <span style="cursor: pointer;" onclick="togglePurchaseDateFilterPopup()">Purchase Date</span>
            <div id="purchaseDateFilterPopup" style="display: none; position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ccc; padding: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 100;">
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <label for="purchaseStartDate" style="margin: 0;">Start</label>
                <input type="date" id="purchaseStartDate" onchange="handlePurchaseDateChange()">
                <label for="purchaseEndDate" style="margin: 0;">End</label>
                <input type="date" id="purchaseEndDate" onchange="handlePurchaseDateChange()">
              </div>
              <button type="button" class="btn btn-secondary btn-sm" onclick="resetPurchaseDateFilter()">Show All</button>
            </div>
          </th>
          <th scope="col">Brand
          <select id="brandFilter" onchange="filterTable()">
            <option value="">All brands</option>
            {% for brand in purchased_brands %}
            <option value="{{ brand }}">{{ brand }}</option>
            {% endfor %}
          </select>
          </th>
          <th scope="col">Category
          <select id="tagFilter" onchange="filterTable()">
            <option value="">All categories</option>
            {% for purchased_cat in purchased_cats %}
            <option value="{{ purchased_cat }}">{{ purchased_cat }}</option>
            {% endfor %}
          </select>
          </th>
          <th scope="col">Name</th>
          <th scope="col">Price (+tax)</th>
          <th scope="col">Wish Period</th>
        </tr>
      </thead>
      <tbody>
      {% set count = namespace(value=0) %}
      {% for purchased_item in purchased_items %}
      {% set count.value = count.value + 1 %}
        {% set wish_period_seconds = purchased_item.wish_period.total_seconds() if purchased_item.wish_period is not none else 0 %}
        {% set wish_period_days = wish_period_seconds / 86400 %}
        {% set row_class = "" %}
        {% if wish_period_days > 0 %}
          {% if wish_period_days < 7 %}
            {% set row_class = "table-danger" %}
          {% elif wish_period_days < 28 %}
            {% set row_class = "table-warning" %}
          {% else %}
            {% set row_class = "table-success" %}
          {% endif %}
        {% endif %}
        <tr class="{{ row_class }}" data-wishitem-category="{{ purchased_item.category }}" data-wishitem-brand="{{ purchased_item.brand }}" data-purchase-date="{{ purchased_item.purchase_date.isoformat() if purchased_item.purchase_date is not none else (purchased_item.date.isoformat() if purchased_item.date is not none else '') }}">
          <th scope="row">{{count.value}}</th>
          <td>
            {% if purchased_item.purchase_date is not none %}
            {{ purchased_item.purchase_date | format_datetime}}
            {% else %}
            {{ purchased_item.date | format_datetime}}  <!-- as an estimate of purchase date, use date when added to wishlist -->
            {% endif %}
          </td>
          <td> {{purchased_item.brand}} </td>
          <td> {{purchased_item.category}} </td>
          <td>
            <a href="{{ purchased_item.link }}" target="_blank" style="color: blue; text-decoration: underline; font-size:11pt">{{purchased_item.name}}</a> <br>
            <span style="font-size: smaller; color: grey; font-style: italic;">
              {{ purchased_item.description | format_description }}
            </span>
          </td>
          <td> {{ (purchased_item.taxed_price|round(2)) | format_money }} </td>
          <td>
            {{(purchased_item.wish_period | format_time).replace("ago", "") }}
            {% if wish_period_days >= 100 %}
            <br>‚ú®üèÜ‚ú®
            {% endif %}
          </td>
          <td>
            <button type="button" class="close js-return" data-id="{{ purchased_item.id }}">
            <span style="color: blue; font-size: 11pt;" aria-hidden="true"> return &#128230</span>
            </button>
          </td>
          <td>
          <button type="button" class="close js-delete" data-id="{{ purchased_item.id }}">
            <span aria-hidden="true">&times;</span>
          </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
      </table>
    </ul>

    <!-- Add the JavaScript code here -->
    <script>
      // Function to filter table based on category, brand, and purchase date range
      function filterTable() {
            var categoryFilter = document.getElementById("tagFilter").value.toLowerCase();
            console.log('categoryFilter:', categoryFilter);
            var brandFilter = document.getElementById("brandFilter").value.toLowerCase();
            console.log('brandFilter:', brandFilter);

            var startInput = document.getElementById("purchaseStartDate");
            var endInput = document.getElementById("purchaseEndDate");
            var startDate = (startInput && startInput.value) ? new Date(startInput.value) : null;
            var endDate = (endInput && endInput.value) ? new Date(endInput.value) : null;
            if (endDate) { endDate.setHours(23,59,59,999); }

            var rows = document.querySelectorAll("#purchasedlist-table tbody tr");

            rows.forEach(row => {
                var tdCategory = (row.getAttribute("data-wishitem-category") || "").toLowerCase();
                console.log('tdCategory:', tdCategory);
                var tdBrand = (row.getAttribute("data-wishitem-brand") || "").toLowerCase();

                var dateAttr = row.getAttribute("data-purchase-date") || '';
                var rowDate = dateAttr ? new Date(dateAttr) : null;

                var categoryMatch = (categoryFilter === "" || tdCategory.includes(categoryFilter));
                var brandMatch = (brandFilter === "" || tdBrand.includes(brandFilter));
                var dateMatch = true;

                if (startDate || endDate) {
                  if (rowDate) {
                    if (startDate && endDate) {
                      dateMatch = rowDate >= startDate && rowDate <= endDate;
                    } else if (startDate) {
                      dateMatch = rowDate >= startDate;
                    } else if (endDate) {
                      dateMatch = rowDate <= endDate;
                    }
                  } else {
                    dateMatch = false;
                  }
                }

                if (categoryMatch && brandMatch && dateMatch) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        function togglePurchaseDateFilterPopup(forceState) {
          var popup = document.getElementById('purchaseDateFilterPopup');
          if (!popup) return;
          if (typeof forceState === 'boolean') {
            popup.style.display = forceState ? 'block' : 'none';
            return;
          }
          popup.style.display = (popup.style.display === 'none' || popup.style.display === '') ? 'block' : 'none';
        }

        function handlePurchaseDateChange() {
          var startInput = document.getElementById('purchaseStartDate');
          var endInput = document.getElementById('purchaseEndDate');
          if (!startInput || !endInput) return;
          if (startInput.value && endInput.value) {
            filterTable();
            togglePurchaseDateFilterPopup(false);
          }
        }

        function resetPurchaseDateFilter() {
          var startInput = document.getElementById('purchaseStartDate');
          var endInput = document.getElementById('purchaseEndDate');
          if (startInput) startInput.value = '';
          if (endInput) endInput.value = '';

          var brandFilterEl = document.getElementById('brandFilter');
          var tagFilterEl = document.getElementById('tagFilter');
          if (brandFilterEl) brandFilterEl.value = '';
          if (tagFilterEl) tagFilterEl.value = '';

          filterTable();
          togglePurchaseDateFilterPopup(false);
        }

      // Attach click handlers for return/delete without inline JS
      document.addEventListener('click', function(event) {
        var returnBtn = event.target.closest('.js-return');
        if (returnBtn) {
          var id = Number(returnBtn.getAttribute('data-id'));
          if (!isNaN(id) && typeof toggleWishItem === 'function') {
            toggleWishItem(id, true, false, '/purchased-list');
          }
          return;
        }
        var deleteBtn = event.target.closest('.js-delete');
        if (deleteBtn) {
          var id = Number(deleteBtn.getAttribute('data-id'));
          if (!isNaN(id) && typeof deleteItem === 'function') {
            deleteItem(id, '/purchased-list');
          }
          return;
        }
      });
    </script>

  <br>
  </div>
 {% endblock %}
