{% extends "base.html" %} {% block title %}Home{% endblock %} {% block content
  %}
    <style>
      .item {
        text-align: center;
      }
      .title {
        text-align: center;
        margin-bottom: 20px;
      }
      .calendar-dropdown-container {
        display: flex;
        align-items: flex-start;
        gap: 30px;
        margin: 20px 0;
      }
      #calendar {
        max-width: 600px;
        transform: scale(0.8);
        transform-origin: top left;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
      .date-selection-container {
        flex: 1;
        text-align: center;
      }
      .dropdown-container {
        margin-bottom: 20px;
      }
      .dropdown-container label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .dropdown-container select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        min-width: 200px;
      }
      .custom-date-container {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
      }
            .date-fields {
        display: flex;
        gap: 10px;
        }
      .report-headline {
          text-align: center;
          font-weight: bold;
        font-size: 1.5em;
      }
      .button-container {
          display: flex;
          justify-content: center;
      }
      .pie-chart-container {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
      }
      .pie-chart-container .item {
        flex: 1;
        text-align: center;
        margin: 0 10px;
      }
      .pie-chart-container img {
          max-width: 100%;
          height: auto;
      }

      /* Home page background pattern */
      body.home-bg {
        /* image from https://www.ebay.com/itm/332202522910 */
        background-image: url('/static/home-pattern.png'); /* place the image at website/static/home-pattern.png */
        background-repeat: repeat;
        background-size: 320px auto; /* keep small to avoid pixelation; adjust as desired */
        background-position: top left;
        background-attachment: scroll;
      }

      /* Translucent content overlay */
      .home-content-card {
        background-color: rgba(255, 255, 255, 0.86);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        padding: 24px;
        margin: 24px auto; /* top/bottom margin and side breathing room */
        max-width: 1100px; /* keep readable width */
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }
    </style>

  <div class="home-content-card">
    <div class="title">
        <br>
        <h1>Hello {{ user.first_name }} !</h1>
    </div>
    <div>
    <p><b> Welcome back to Unhooked. Here is your report. </b></p>
        <br>
        {{ (current_time) | debug }}
        {{ (user.last_purchase_date) | debug }}
        {% set time_difference = current_time - user.last_purchase_date %}
        ‚≠êÔ∏è Your last online purchase date is {{ user.last_purchase_date | format_last_purchase_date }} which is
        <span style="color: {% if time_difference >= ten_days %}blue{% else %}red{% endif %};">
      <b>{{ (time_difference) | format_time }}</b>
        </span>
        .
        {% set totalpurchasedprice = namespace(value=0.00) %}
        {% for wishitem in user.wishitems %}
        {% if not wishitem.unhooked and wishitem.purchased %}
        {% set totalpurchasedprice.value = totalpurchasedprice.value + wishitem.taxed_price %}
        {% endif %}
        {% endfor %}
    {% set totalpurchasedprice.value = totalpurchasedprice.value|round(2) %}
    <p> ‚≠êÔ∏è Your total purchase amount is <b>$<span id="total-purchase-amount">{{ totalpurchasedprice.value | format_money }}</span></b> <span id="date-range-text">.</span></p>
        <br>
                <div class="calendar-dropdown-container">
          <div id='calendar'></div>
          <div class="date-selection-container">
            <div class="dropdown-container">
              <label for="dateRangeDropdown">Select Date Range:</label>
              <select id="dateRangeDropdown" class="form-control">
                <option value="">Choose a date range...</option>
                <option value="last7days">Last 7 days</option>
                <option value="last14days">Last 14 days</option>
                <option value="last30days" selected>Last 30 days</option>
                <option value="thisMonth">This Month</option>
                <option value="thisYear">This Year</option>
                <option value="last365days">Last 365 days</option>
                <option value="specifyDate">Specify Date</option>
              </select>
            </div>
            <div id="customDateContainer" class="custom-date-container" style="display: none;">
              <div class="date-fields">
                <div>
                  <label for="start_date">Start Date (YYYY-MM-DD):</label>
                  <input type="text" id="start_date" name="start_date" placeholder="YYYY-MM-DD">
                </div>
                <div>
                  <label for="end_date">End Date (YYYY-MM-DD):</label>
                  <input type="text" id="end_date" name="end_date" placeholder="YYYY-MM-DD">
                </div>
              </div>
            </div>
          </div>
        </div>

    <!-- Spending Line Graph -->
    <div class="spending-graph-container">
      <h5 style="text-align: center; margin: 20px 0;">Purchased Items Over Time</h5>
      <div style="position: relative; height: 400px; width: 100%; max-width: 800px; margin: 0 auto;">
        <canvas id="spendingChart"></canvas>
      </div>
    </div>

    <!-- Wishlist Additions Line Graph -->
    <div class="wishlist-graph-container">
      <h5 style="text-align: center; margin: 20px 0;">Wishlist Additions Over Time</h5>
      <div style="position: relative; height: 400px; width: 100%; max-width: 800px; margin: 0 auto;">
        <canvas id="wishlistChart"></canvas>
      </div>
    </div>

    <div class="pie-chart-container">
      <div class="item">
        <h5>Wish List Category</h5>
        <img id="category-chart" src="/wishlist_category.png" alt="Wish List Category Plot">
      </div>
      <div class="item">
        <h5>Wish List Brand</h5>
        <img id="brand-chart" src="/wishlist_brand.png" alt="Wish List Brand Plot">
      </div>
    </div>

    <div class="pie-chart-container">
      <div class="item">
        <h5>Purchased Category</h5>
        <img id="purchased-category-chart" src="/purchased_category.png" alt="Purchased Category Plot">
      </div>
      <div class="item">
        <h5>Purchased Brand</h5>
        <img id="purchased-brand-chart" src="/purchased_brand.png" alt="Purchased Brand Plot">
      </div>
    </div>
  </div>
  </div>
{% endblock %}

{% block javascript %}
{{ super() }}
<script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
            <script>
        $(document).ready(function() {
    // Enable home background pattern
    $('body').addClass('home-bg');

            const spenditure = {{ spenditure | tojson}};
            const saves = {{ saves | tojson }};

    // Charts and tooltips
            let spendingChart = null;
    let currentTooltip = null;
    let wishlistChart = null;

            function showCustomTooltip(event, dataIndex, spendingData, chartData, mouseX, mouseY, rect) {
                if (currentTooltip) {
                    currentTooltip.remove();
                    currentTooltip = null;
                }
                const allTooltips = document.querySelectorAll('[id*="tooltip"], [class*="tooltip"]');
      allTooltips.forEach(tooltip => tooltip.remove());

                const value = spendingData[dataIndex];
                const date = chartData.labels[dataIndex];
                if (value > 0) {
                    const itemsOnDate = chartData.items.filter(item => item.date === date);
                    let tooltipContent = '';
                    tooltipContent += '<strong style="color: #e74c3c; font-size: 14px;">Date: ' + date + '</strong><br>';
                    if (itemsOnDate.length === 1) {
                        const item = itemsOnDate[0];
                        tooltipContent += 'Total: $' + value.toFixed(2) + '<br>';
                        tooltipContent += 'Item: ' + item.name + '<br>';
                        tooltipContent += 'Brand: ' + item.brand + '<br>';
                        tooltipContent += 'Category: ' + item.category + '<br>';
                        tooltipContent += 'Price: $' + item.price.toFixed(2);
                    } else if (itemsOnDate.length > 1) {
                        tooltipContent += 'Total: $' + value.toFixed(2) + '<br>';
                        tooltipContent += 'Items:<br>';
                        itemsOnDate.forEach((item, index) => {
                            tooltipContent += '  ' + (index + 1) + '. ' + item.name + ' - $' + item.price.toFixed(2) + '<br>';
                        });
                    }
                    currentTooltip = document.createElement('div');
                    currentTooltip.id = 'custom-tooltip';
                    currentTooltip.style.position = 'fixed';
                    currentTooltip.style.pointerEvents = 'none';
                    currentTooltip.style.zIndex = '9999';
        currentTooltip.style.backgroundColor = 'rgba(255, 228, 225, 0.95)';
        currentTooltip.style.border = '1px solid #ffb6c1';
                    currentTooltip.style.borderRadius = '5px';
                    currentTooltip.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                    currentTooltip.style.fontFamily = 'Arial, sans-serif';
                    currentTooltip.style.fontSize = '12px';
                    currentTooltip.style.color = '#333';
                    currentTooltip.style.minWidth = '200px';
                    currentTooltip.style.padding = '10px';
                    document.body.appendChild(currentTooltip);
                    currentTooltip.innerHTML = tooltipContent;

        const tooltipWidth = 200;
        const tooltipHeight = 120;
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    let left = rect.left + mouseX + 15;
                    let top = rect.top + mouseY - 15;
                    if (left + tooltipWidth > viewportWidth) {
                        left = rect.left + mouseX - tooltipWidth - 15;
                    }
                    if (top + tooltipHeight > viewportHeight) {
                        top = rect.top + mouseY - tooltipHeight - 15;
                    }
                    if (left < 0) left = 15;
                    if (top < 0) top = 15;
                    currentTooltip.style.left = left + 'px';
                    currentTooltip.style.top = top + 'px';
                    currentTooltip.style.display = 'block';
                    currentTooltip.style.visibility = 'visible';
                    currentTooltip.style.opacity = '1';
                }
            }

            function hideCustomTooltip() {
                if (currentTooltip) {
                    currentTooltip.remove();
                    currentTooltip = null;
                }
                const allTooltips = document.querySelectorAll('[id*="tooltip"], [class*="tooltip"]');
      allTooltips.forEach(tooltip => tooltip.remove());
            }

            function getPurchasedItemsData() {
                const purchasedItems = [];
                {% for wishitem in user.wishitems %}
                    {% if wishitem.purchased and wishitem.purchase_date %}
                        purchasedItems.push({
                            date: '{{ wishitem.purchase_date.strftime("%Y-%m-%d") }}',
                            price: {{ wishitem.price }},
                            name: '{{ wishitem.name }}',
                            brand: '{{ wishitem.brand }}',
                            category: '{{ wishitem.category }}',
                            description: '{{ wishitem.description }}'
                        });
                    {% endif %}
                {% endfor %}
                return purchasedItems;
            }

            function getUnhookedItemsData() {
                const unhookedItems = [];
                {% for wishitem in user.wishitems %}
                    {% if wishitem.unhooked and wishitem.unhooked_date %}
                        unhookedItems.push({
                            date: '{{ wishitem.unhooked_date.strftime("%Y-%m-%d") }}',
                            price: {{ wishitem.price }},
                            name: '{{ wishitem.name }}',
                            brand: '{{ wishitem.brand }}',
                            category: '{{ wishitem.category }}',
                            description: '{{ wishitem.description }}'
                        });
                    {% endif %}
                {% endfor %}
                return unhookedItems;
            }

    function getWishlistItemsData() {
      const wishlistItems = [];
      {% for wishitem in user.wishitems %}
        {% if wishitem.date %}
          wishlistItems.push({
            date: '{{ wishitem.date.strftime("%Y-%m-%d") }}',
            price: {{ wishitem.price if wishitem.price else 0 }},
            name: '{{ wishitem.name }}',
            brand: '{{ wishitem.brand }}',
            category: '{{ wishitem.category }}',
            description: '{{ wishitem.description }}'
          });
        {% endif %}
      {% endfor %}
      return wishlistItems;
    }

    function showWishlistTooltip(event, dataIndex, datasetIndex, countAdded, countUnhooked, chartData, mouseX, mouseY, rect) {
      if (currentTooltip) {
        currentTooltip.remove();
        currentTooltip = null;
      }
      const allTooltips = document.querySelectorAll('[id*="tooltip"], [class*="tooltip"]');
      allTooltips.forEach(tooltip => tooltip.remove());

      const date = chartData.labels[dataIndex];
      const isAdded = datasetIndex === 0;
      const value = isAdded ? countAdded[dataIndex] : countUnhooked[dataIndex];
      if (value > 0) {
        const itemsOnDate = (isAdded ? chartData.itemsAdded : chartData.itemsUnhooked).filter(item => item.date === date);
        let tooltipContent = '';
        const headerColor = isAdded ? '#6c757d' : '#28a745';
        tooltipContent += '<strong style="color: ' + headerColor + '; font-size: 14px;">Date: ' + date + '</strong><br>';
        tooltipContent += (isAdded ? 'Added: ' : 'Unhooked: ') + value + ' item' + (value > 1 ? 's' : '') + '<br>';
        if (itemsOnDate.length > 0) {
          const totalForDay = itemsOnDate.reduce((sum, item) => sum + (Number(item.price) || 0), 0);
          tooltipContent += 'Total: $' + totalForDay.toFixed(2) + '<br>';
          tooltipContent += 'Items:<br>';
          itemsOnDate.forEach((item, index) => {
            const itemPrice = (Number(item.price) || 0).toFixed(2);
            tooltipContent += '  ' + (index + 1) + '. ' + item.name + ' - $' + itemPrice + '<br>';
          });
        }
        currentTooltip = document.createElement('div');
        currentTooltip.id = 'custom-tooltip';
        currentTooltip.style.position = 'fixed';
        currentTooltip.style.pointerEvents = 'none';
        currentTooltip.style.zIndex = '9999';
        currentTooltip.style.backgroundColor = isAdded ? 'rgba(233, 236, 239, 0.95)' : 'rgba(212, 237, 218, 0.95)';
        currentTooltip.style.border = '1px solid ' + (isAdded ? '#ced4da' : '#c3e6cb');
        currentTooltip.style.borderRadius = '5px';
        currentTooltip.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        currentTooltip.style.fontFamily = 'Arial, sans-serif';
        currentTooltip.style.fontSize = '12px';
        currentTooltip.style.color = '#333';
        currentTooltip.style.minWidth = '200px';
        currentTooltip.style.padding = '10px';
        document.body.appendChild(currentTooltip);
        currentTooltip.innerHTML = tooltipContent;

        const tooltipWidth = 200;
        const tooltipHeight = 120;
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        let left = rect.left + mouseX + 15;
        let top = rect.top + mouseY - 15;
        if (left + tooltipWidth > viewportWidth) {
          left = rect.left + mouseX - tooltipWidth - 15;
        }
        if (top + tooltipHeight > viewportHeight) {
          top = rect.top + mouseY - tooltipHeight - 15;
        }
        if (left < 0) left = 15;
        if (top < 0) top = 15;
        currentTooltip.style.left = left + 'px';
        currentTooltip.style.top = top + 'px';
        currentTooltip.style.display = 'block';
        currentTooltip.style.visibility = 'visible';
        currentTooltip.style.opacity = '1';
      }
    }

    function updateWishlistChart(startDate, endDate) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        return;
      }
      const canvas = document.getElementById('wishlistChart');
      if (!canvas) {
        console.error('Canvas element #wishlistChart not found!');
        return;
      }
      const start = new Date(startDate);
      const end = new Date(endDate);
      const today = new Date();
      const extendedEnd = new Date(Math.max(end, today));

      const allWishlistItems = getWishlistItemsData();
      const allUnhookedItems = getUnhookedItemsData();
      const filteredAdded = allWishlistItems.filter(item => {
        const itemDate = new Date(item.date);
        return itemDate >= start && itemDate <= end;
      });
      const filteredUnhooked = allUnhookedItems.filter(item => {
        const itemDate = new Date(item.date);
        return itemDate >= start && itemDate <= end;
      });
      filteredAdded.sort((a, b) => new Date(a.date) - new Date(b.date));
      filteredUnhooked.sort((a, b) => new Date(a.date) - new Date(b.date));

      const extendedLabels = [];
      const currentDate = new Date(start);
      while (currentDate <= extendedEnd) {
        extendedLabels.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
      }

      const countAdded = extendedLabels.map(date => filteredAdded.filter(item => item.date === date).length);
      const countUnhooked = extendedLabels.map(date => filteredUnhooked.filter(item => item.date === date).length);

      const pointRadiusAdded = countAdded.map(value => value > 0 ? 4 : 0);
      const pointHoverRadiusAdded = countAdded.map(value => value > 0 ? 6 : 0);
      const pointRadiusUnhooked = countUnhooked.map(value => value > 0 ? 4 : 0);
      const pointHoverRadiusUnhooked = countUnhooked.map(value => value > 0 ? 6 : 0);

      const daysDiff = Math.ceil((extendedEnd - start) / (1000 * 60 * 60 * 24));
      let maxTicksLimit = 10;
      if (daysDiff > 365) {
        maxTicksLimit = 12;
      } else if (daysDiff > 90) {
        maxTicksLimit = 20;
      } else if (daysDiff > 30) {
        maxTicksLimit = 15;
      }

      if (wishlistChart) {
        wishlistChart.destroy();
      }

      const ctx = document.getElementById('wishlistChart').getContext('2d');
      const chartData = { labels: extendedLabels, itemsAdded: filteredAdded, itemsUnhooked: filteredUnhooked };
      wishlistChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: extendedLabels,
          datasets: [
            {
              label: 'Wishlist Items Added',
              data: countAdded,
              borderColor: '#6c757d',
              backgroundColor: 'rgba(108, 117, 125, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1,
              pointRadius: pointRadiusAdded,
              pointHoverRadius: pointHoverRadiusAdded,
              pointBackgroundColor: '#6c757d',
              pointBorderColor: '#6c757d'
            },
            {
              label: 'Unhooked Items',
              data: countUnhooked,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1,
              pointRadius: pointRadiusUnhooked,
              pointHoverRadius: pointHoverRadiusUnhooked,
              pointBackgroundColor: '#28a745',
              pointBorderColor: '#28a745'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: true, mode: 'nearest' },
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { enabled: false }
          },
          onHover: function(event, elements) {
            const canvas = event.native.target;
            if (elements.length > 0) {
              const dataIndex = elements[0].index;
              const datasetIndex = elements[0].datasetIndex;
              const value = datasetIndex === 0 ? countAdded[dataIndex] : countUnhooked[dataIndex];
              if (value > 0) {
                canvas.style.cursor = 'pointer';
                const rect = canvas.getBoundingClientRect();
                const mouseX = event.native.clientX - rect.left;
                const mouseY = event.native.clientY - rect.top;
                showWishlistTooltip(event, dataIndex, datasetIndex, countAdded, countUnhooked, chartData, mouseX, mouseY, rect);
              } else {
                canvas.style.cursor = 'default';
                hideCustomTooltip();
              }
            } else {
              event.native.target.style.cursor = 'default';
              hideCustomTooltip();
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Date Added' },
              ticks: { maxTicksLimit: maxTicksLimit, maxRotation: 45 }
            },
            y: {
              title: { display: true, text: 'Items Added / Unhooked' },
              beginAtZero: true,
              ticks: { precision: 0, callback: function(value) { return value; } }
            }
          }
        }
      });
    }

            function updateSpendingChart(startDate, endDate) {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded!');
                    return;
                }
                const canvas = document.getElementById('spendingChart');
                if (!canvas) {
                    console.error('Canvas element #spendingChart not found!');
                    return;
                }
                const start = new Date(startDate);
                const end = new Date(endDate);
                const today = new Date();
                const extendedEnd = new Date(Math.max(end, today));

                const allPurchasedItems = getPurchasedItemsData();
                const filteredItems = allPurchasedItems.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= start && itemDate <= end;
                });
                filteredItems.sort((a, b) => new Date(a.date) - new Date(b.date));

                const extendedLabels = [];
                const currentDate = new Date(start);
                while (currentDate <= extendedEnd) {
                    extendedLabels.push(currentDate.toISOString().split('T')[0]);
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                const spendingData = extendedLabels.map(date => {
                    const itemsOnDate = filteredItems.filter(item => item.date === date);
                    if (itemsOnDate.length === 0) {
          return 0;
                    }
                    return itemsOnDate.reduce((total, item) => total + item.price, 0);
                });

                const pointRadius = spendingData.map(value => value > 0 ? 4 : 0);
                const hoverRadius = spendingData.map(value => value > 0 ? 6 : 0);

                const daysDiff = Math.ceil((extendedEnd - start) / (1000 * 60 * 60 * 24));
      let maxTicksLimit = 10;
                if (daysDiff > 365) {
        maxTicksLimit = 12;
                } else if (daysDiff > 90) {
        maxTicksLimit = 20;
                } else if (daysDiff > 30) {
        maxTicksLimit = 15;
                }

                if (spendingChart) {
                    spendingChart.destroy();
                }

                const ctx = document.getElementById('spendingChart').getContext('2d');
      const chartData = { labels: extendedLabels, items: filteredItems };
                spendingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: extendedLabels,
                        datasets: [{
                            label: 'Total Daily Spending',
                            data: spendingData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: pointRadius,
                            pointHoverRadius: hoverRadius,
                            pointBackgroundColor: 'rgb(255, 99, 132)',
                            pointBorderColor: 'rgb(255, 99, 132)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
          interaction: { intersect: true, mode: 'nearest' },
                        plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { enabled: false }
                        },
                        onHover: function(event, elements) {
                            const canvas = event.native.target;
                            if (elements.length > 0) {
                                const dataIndex = elements[0].index;
                                const value = spendingData[dataIndex];
                                if (value > 0) {
                                    canvas.style.cursor = 'pointer';
                                    const rect = canvas.getBoundingClientRect();
                                    const mouseX = event.native.clientX - rect.left;
                                    const mouseY = event.native.clientY - rect.top;
                                    showCustomTooltip(event, dataIndex, spendingData, chartData, mouseX, mouseY, rect);
                                } else {
                                    canvas.style.cursor = 'default';
                                    hideCustomTooltip();
                                }
                            } else {
                                canvas.style.cursor = 'default';
                                hideCustomTooltip();
                            }
                        },
                        scales: {
                            x: {
              title: { display: true, text: 'Purchase Date' },
              ticks: { maxTicksLimit: maxTicksLimit, maxRotation: 45 }
                            },
                            y: {
              title: { display: true, text: 'Total Daily Spending ($)' },
                                beginAtZero: true,
              ticks: { callback: function(value) { return '$' + value.toFixed(2); } }
                            }
                        }
                    }
                });
    }

            function generateReport(startDate, endDate) {
                $.ajax({
                    url: '/generate-report',
                    method: 'POST',
                    contentType: 'application/json',
        data: JSON.stringify({ start_date: startDate, end_date: endDate }),
                    success: function(response) {
          $('#total-purchase-amount').text(response.total_purchase_amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                        $('#date-range-text').text('from ' + response.start_date + ' to ' + response.end_date + '.');
                        $('#category-chart').attr('src', 'data:image/png;base64,' + response.category_chart);
                        $('#brand-chart').attr('src', 'data:image/png;base64,' + response.brand_chart);
                        $('#purchased-category-chart').attr('src', 'data:image/png;base64,' + response.purchased_category_chart);
                        $('#purchased-brand-chart').attr('src', 'data:image/png;base64,' + response.purchased_brand_chart);
                        updateSpendingChart(response.start_date, response.end_date);
          updateWishlistChart(response.start_date, response.end_date);
                    },
                    error: function(xhr) {
                        const response = xhr.responseJSON;
                        alert('Error generating report: ' + (response ? response.error : 'Unknown error'));
                    }
                });
            }

            $('#dateRangeDropdown').change(function() {
                const selectedOption = $(this).val();
                if (selectedOption === 'specifyDate') {
                    $('#customDateContainer').show();
                    $('#start_date').val('').focus();
                    $('#end_date').val('');
                    resetToAllPurchases();
                    localStorage.setItem('selectedTimeRange', selectedOption);
                } else if (selectedOption) {
                    $('#customDateContainer').hide();
                    const dateRange = getDateRange(selectedOption);
                    if (dateRange) {
                        generateReport(dateRange.start, dateRange.end);
                        updateSpendingChart(dateRange.start, dateRange.end);
          updateWishlistChart(dateRange.start, dateRange.end);
                    }
                    localStorage.setItem('selectedTimeRange', selectedOption);
                } else {
                    $('#customDateContainer').hide();
                    resetToAllPurchases();
                    localStorage.setItem('selectedTimeRange', '');
                }
            });

            function resetToAllPurchases() {
                let totalAllPurchases = 0;
                Object.values(spenditure).forEach(function(amount) {
                    const cleanAmount = parseFloat(amount.replace(/,/g, ''));
                    totalAllPurchases += cleanAmount;
                });
      $('#total-purchase-amount').text(totalAllPurchases.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                $('#date-range-text').text('.');
                $('#category-chart').attr('src', '/wishlist_category.png');
                $('#brand-chart').attr('src', '/wishlist_brand.png');
                $('#purchased-category-chart').attr('src', '/purchased_category.png');
                $('#purchased-brand-chart').attr('src', '/purchased_brand.png');
                updateSpendingChart('{{ user.last_purchase_date.strftime("%Y-%m-%d") }}', '{{ current_time.strftime("%Y-%m-%d") }}');
      (function() {
        const allWishlistItems = getWishlistItemsData();
        if (allWishlistItems.length > 0) {
          const dates = allWishlistItems.map(i => new Date(i.date));
          dates.sort((a, b) => a - b);
          const earliest = dates[0].toISOString().split('T')[0];
          const today = new Date().toISOString().split('T')[0];
          updateWishlistChart(earliest, today);
        }
      })();
    }

            $('#end_date').on('input', function() {
                const startDate = $('#start_date').val();
                const endDate = $(this).val();
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (startDate && endDate && dateRegex.test(startDate) && dateRegex.test(endDate)) {
                    generateReport(startDate, endDate);
                    updateSpendingChart(startDate, endDate);
        updateWishlistChart(startDate, endDate);
                    localStorage.setItem('selectedTimeRange', 'specifyDate');
                    localStorage.setItem('customStartDate', startDate);
                    localStorage.setItem('customEndDate', endDate);
                } else if (!startDate || !endDate) {
                    resetToAllPurchases();
                    localStorage.removeItem('customStartDate');
                    localStorage.removeItem('customEndDate');
                }
            });

            $('#start_date').on('input', function() {
                const startDate = $(this).val();
                const endDate = $('#end_date').val();
                if (!startDate || !endDate) {
                    resetToAllPurchases();
                    localStorage.removeItem('customStartDate');
                    localStorage.removeItem('customEndDate');
                }
            });

            function getDateRange(option) {
                const today = new Date();
                const endDate = new Date(today);
                let startDate = new Date(today);
                switch(option) {
                    case 'last7days':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case 'last14days':
                        startDate.setDate(today.getDate() - 14);
                        break;
                    case 'last30days':
                        startDate.setDate(today.getDate() - 30);
                        break;
                    case 'thisMonth':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        break;
                    case 'thisYear':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        break;
                    case 'last365days':
                        startDate.setDate(today.getDate() - 365);
                        break;
                    default:
                        return null;
                }
      return { start: startDate.toISOString().split('T')[0], end: endDate.toISOString().split('T')[0] };
    }

    const calendarEvents = Object.keys(spenditure).map(function(date) {
      return { title: 'üí∏ ' + '-' + spenditure[date], start: date, color: 'lightpink', textColor: 'red' };
    }).concat(Object.keys(saves).map(function(date) {
      return { title: 'üí∞ ' + '+' + saves[date], start: date, color: 'lightgreen', textColor: 'green' };
    }));

    $('#calendar').fullCalendar({ selectable: false, selectHelper: false, events: calendarEvents });

            const defaultDateRange = getDateRange('last30days');
            if (defaultDateRange) {
                updateSpendingChart(defaultDateRange.start, defaultDateRange.end);
      updateWishlistChart(defaultDateRange.start, defaultDateRange.end);
            }

            const savedTimeRange = localStorage.getItem('selectedTimeRange');
    let selectedOption = 'last30days';
            if (savedTimeRange) {
                selectedOption = savedTimeRange;
                $('#dateRangeDropdown').val(selectedOption);
                if (selectedOption === 'specifyDate') {
                    const savedStartDate = localStorage.getItem('customStartDate');
                    const savedEndDate = localStorage.getItem('customEndDate');
                    if (savedStartDate && savedEndDate) {
                        $('#customDateContainer').show();
                        $('#start_date').val(savedStartDate);
                        $('#end_date').val(savedEndDate);
                        generateReport(savedStartDate, savedEndDate);
                    } else {
                        selectedOption = 'last30days';
                        $('#dateRangeDropdown').val(selectedOption);
                        const dateRange = getDateRange(selectedOption);
                        if (dateRange) {
                            generateReport(dateRange.start, dateRange.end);
                        }
                    }
                } else {
                    const dateRange = getDateRange(selectedOption);
                    if (dateRange) {
                        generateReport(dateRange.start, dateRange.end);
                    }
                }
            } else {
                $('#dateRangeDropdown').val('last30days');
                const dateRange = getDateRange(selectedOption);
                if (dateRange) {
                    generateReport(dateRange.start, dateRange.end);
                }
            }
        });
    </script>
{% endblock %}
