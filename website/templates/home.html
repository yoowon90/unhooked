{% extends "base.html" %} {% block title %}Home{% endblock %} {% block content
  %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <!-- FullCalendar CSS -->
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet' />
    <!-- jQuery -->
    <script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>
    <!-- FullCalendar JS -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>
    <style>
      .item {
        text-align: center;
      }
      .title {
        text-align: center;
        margin-bottom: 20px; /* Add some space below the title */
      }
      .calendar-dropdown-container {
        display: flex;
        align-items: flex-start;
        gap: 30px;
        margin: 20px 0;
      }
      #calendar {
        max-width: 600px;
        transform: scale(0.8);
        transform-origin: top left;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
      .date-selection-container {
        flex: 1;
        text-align: center;
      }
      .dropdown-container {
        margin-bottom: 20px;
      }
      .dropdown-container label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .dropdown-container select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        min-width: 200px;
      }
      .custom-date-container {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
      }

            .date-fields {
          display: flex; /* Use flexbox to align items side by side */
          gap: 10px; /* Add some space between the fields */
        }

      .report-headline {
          text-align: center;
          font-weight: bold;
          font-size: 1.5em; /* Adjust the size as needed */
      }

      .button-container {
          display: flex;
          justify-content: center;
      }

      .pie-chart-container {
          display: flex; /* Use flexbox to align items side by side */
          justify-content: space-around; /* Distribute space around the items */
          margin-top: 20px; /* Add some space above the pie chart container */
      }

      .pie-chart-container .item {
          flex: 1; /* Allow items to grow and fill the container */
          text-align: center; /* Center the text within each item */
          margin: 0 10px; /* Add some horizontal space between items */
      }

      .pie-chart-container img {
          max-width: 100%;
          height: auto;
      }
    </style>
</head>
<body>
    <div class="title">
        <br>
        <h1>Hello {{ user.first_name }} !</h1>
    </div>
    <div>
        <p>  <b> Welcome back to Unhooked. Here is your report. </b> </p>
        <br>
        {{ (current_time) | debug }}
        {{ (user.last_purchase_date) | debug }}
        {% set time_difference = current_time - user.last_purchase_date %}
        ⭐️ Your last online purchase date is {{ user.last_purchase_date | format_last_purchase_date }} which is
        <span style="color: {% if time_difference >= ten_days %}blue{% else %}red{% endif %};">
          <b> {{ (time_difference) | format_time}}</b>
        </span>
        .
        {% set totalpurchasedprice = namespace(value=0.00) %}
        {% for wishitem in user.wishitems %}
        {% if not wishitem.unhooked and wishitem.purchased %}
        {% endif %}
        {% if not wishitem.unhooked and wishitem.purchased %}
        {% set totalpurchasedprice.value = totalpurchasedprice.value + wishitem.taxed_price %}
        {% endif %}
        {% endfor %}
        {% set totalpurchasedprice.value =  totalpurchasedprice.value|round(2) %}
        <p> ⭐️ Your total purchase amount is <b> $<span id="total-purchase-amount">{{ totalpurchasedprice.value | format_money }}</span> </b> <span id="date-range-text">.</span> </p>
        <br>
                <div class="calendar-dropdown-container">
          <div id='calendar'></div>
          <div class="date-selection-container">
            <div class="dropdown-container">
              <label for="dateRangeDropdown">Select Date Range:</label>
              <select id="dateRangeDropdown" class="form-control">
                <option value="">Choose a date range...</option>
                <option value="last7days">Last 7 days</option>
                <option value="last14days">Last 14 days</option>
                <option value="last30days">Last 30 days</option>
                <option value="thisYear">This Year</option>
                <option value="last365days">Last 365 days</option>
                <option value="specifyDate">Specify Date</option>
              </select>
            </div>

            <div id="customDateContainer" class="custom-date-container" style="display: none;">
              <div class="date-fields">
                <div>
                  <label for="start_date">Start Date (YYYY-MM-DD):</label>
                  <input type="text" id="start_date" name="start_date" placeholder="YYYY-MM-DD">
                </div>
                <div>
                  <label for="end_date">End Date (YYYY-MM-DD):</label>
                  <input type="text" id="end_date" name="end_date" placeholder="YYYY-MM-DD">
                </div>
              </div>
            </div>
          </div>
        </div>

            <script>
        $(document).ready(function() {
            const spenditure = {{ spenditure | tojson}};
            const saves = {{ saves | tojson }};

            // Function to calculate date ranges
            function getDateRange(option) {
                const today = new Date();
                const endDate = new Date(today);
                let startDate = new Date(today);

                switch(option) {
                    case 'last7days':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case 'last14days':
                        startDate.setDate(today.getDate() - 14);
                        break;
                    case 'last30days':
                        startDate.setDate(today.getDate() - 30);
                        break;
                    case 'thisYear':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        break;
                    case 'last365days':
                        startDate.setDate(today.getDate() - 365);
                        break;
                    default:
                        return null;
                }

                return {
                    start: startDate.toISOString().split('T')[0],
                    end: endDate.toISOString().split('T')[0]
                };
            }

            // Function to generate report
            function generateReport(startDate, endDate) {
                $.ajax({
                    url: '/generate-report',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    }),
                    success: function(response) {
                        // Update total purchase amount
                        $('#total-purchase-amount').text(response.total_purchase_amount.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }));

                        // Update date range text
                        $('#date-range-text').text('from ' + response.start_date + ' to ' + response.end_date + '.');

                        // Update pie charts
                        $('#category-chart').attr('src', 'data:image/png;base64,' + response.category_chart);
                        $('#brand-chart').attr('src', 'data:image/png;base64,' + response.brand_chart);
                        $('#purchased-category-chart').attr('src', 'data:image/png;base64,' + response.purchased_category_chart);
                        $('#purchased-brand-chart').attr('src', 'data:image/png;base64,' + response.purchased_brand_chart);
                    },
                    error: function(xhr) {
                        const response = xhr.responseJSON;
                        alert('Error generating report: ' + (response ? response.error : 'Unknown error'));
                    }
                });
            }

                        // Handle dropdown change
            $('#dateRangeDropdown').change(function() {
                const selectedOption = $(this).val();

                if (selectedOption === 'specifyDate') {
                    // Show custom date inputs
                    $('#customDateContainer').show();
                    $('#start_date').val('').focus();
                    $('#end_date').val('');
                    // Reset to show all purchases
                    resetToAllPurchases();
                } else if (selectedOption) {
                    // Hide custom date inputs
                    $('#customDateContainer').hide();

                    // Get date range and generate report
                    const dateRange = getDateRange(selectedOption);
                    if (dateRange) {
                        generateReport(dateRange.start, dateRange.end);
                    }
                } else {
                    // Reset everything
                    $('#customDateContainer').hide();
                    resetToAllPurchases();
                }
            });

                                                // Function to reset to show all purchases
            function resetToAllPurchases() {
                // Calculate total of all purchases
                let totalAllPurchases = 0;
                Object.values(spenditure).forEach(function(amount) {
                    // Remove commas and convert to number
                    const cleanAmount = parseFloat(amount.replace(/,/g, ''));
                    totalAllPurchases += cleanAmount;
                });

                // Update total purchase amount
                $('#total-purchase-amount').text(totalAllPurchases.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }));

                // Clear date range text and add period
                $('#date-range-text').text('.');

                // Reset pie charts to show all wishlist items (no date filtering)
                $('#category-chart').attr('src', '/wishlist_category.png');
                $('#brand-chart').attr('src', '/wishlist_brand.png');
                $('#purchased-category-chart').attr('src', '/purchased_category.png');
                $('#purchased-brand-chart').attr('src', '/purchased_brand.png');
            }

            // Handle custom date input
            $('#end_date').on('input', function() {
                const startDate = $('#start_date').val();
                const endDate = $(this).val();

                // Check if both dates are filled and in correct format
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (startDate && endDate && dateRegex.test(startDate) && dateRegex.test(endDate)) {
                    generateReport(startDate, endDate);
                } else if (!startDate || !endDate) {
                    // If dates are cleared, reset to all purchases
                    resetToAllPurchases();
                }
            });

            // Also handle start date input
            $('#start_date').on('input', function() {
                const startDate = $(this).val();
                const endDate = $('#end_date').val();

                if (!startDate || !endDate) {
                    // If either date is cleared, reset to all purchases
                    resetToAllPurchases();
                }
            });

            // Initialize calendar (read-only, no click functionality)
            console.log('Spenditure data:', spenditure);
            console.log('Saves data:', saves);

            const calendarEvents = Object.keys(spenditure).map(function(date) {
                return {
                    title: '💸 ' + '-' + spenditure[date], // total price purchased
                    start: date, // Use the key as the start date
                    color: 'lightpink', // Light red background color
                    textColor: 'red' // Red text color
                };
            }).concat(Object.keys(saves).map(function(date) {
                return {
                    title: '💰 ' + '+' + saves[date], // total price unhooked
                    start: date, // Use the key as the start date
                    color: 'lightgreen', // Light green background color
                    textColor: 'green' // Green text color
                };
            }));

            console.log('Calendar events:', calendarEvents);

            $('#calendar').fullCalendar({
                selectable: false, // Disable date selection
                selectHelper: false,
                events: calendarEvents
            });

        });
    </script>

    <div class="pie-chart-container">
        <div class="item">
            <h5>Wish List Category</h5>
            <img id="category-chart" src="/wishlist_category.png" alt="Wish List Category Plot">
        </div>
        <div class="item">
            <h5>Wish List Brand</h5>
            <img id="brand-chart" src="/wishlist_brand.png" alt="Wish List Brand Plot">
        </div>
    </div>

    <div class="pie-chart-container">
        <div class="item">
            <h5>Purchased Category</h5>
            <img id="purchased-category-chart" src="/purchased_category.png" alt="Purchased Category Plot">
        </div>
        <div class="item">
            <h5>Purchased Brand</h5>
            <img id="purchased-brand-chart" src="/purchased_brand.png" alt="Purchased Brand Plot">
        </div>
    </div>
</body>
</html>
{% endblock %}
